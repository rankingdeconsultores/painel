<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANKING AMMO</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root { --bg-dark: #0f1016; --bg-card: #1b1d29; --text-main: #ffffff; --text-muted: #8b9bb4; --gold: #ffd700; --green: #00e676; --blue: #2979ff; --red: #ff1744; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Cabe√ßalho */
        .main-header-title { text-align: center; padding: 10px 0; background: #111219; border-bottom: 1px solid #2a2d3e; z-index: 101; }
        .main-header-title h1 { margin: 0; font-size: 1.5rem; font-weight: 900; letter-spacing: 2px; color: #fff; text-transform: uppercase; }
        .main-header-title h1 span { color: var(--gold); }

        /* M√©tricas */
        .header-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; background: #151720; border-bottom: 1px solid #2a2d3e; }
        .metric-card { background: var(--bg-card); border-radius: 8px; padding: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #2a2d3e; }
        .metric-card h3 { margin: 0; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .metric-card .value { font-size: 1.1rem; font-weight: 800; margin-top: 3px; }

        /* √ÅREA DO GR√ÅFICO */
        .chart-section {
            background: rgba(21, 23, 32, 0.5);
            padding: 5px 20px;
            height: 200px; /* Altura controlada */
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px solid #2a2d3e;
            display: flex;
            justify-content: center;
        }
        .chart-container { position: relative; width: 98%; height: 100%; }

        /* Layout Principal */
        .dashboard-container { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; background: radial-gradient(circle at 50% 50%, #1f2233 0%, #0f1016 80%); }
        
        /* P√≥dio */
        .podium-section { 
            flex: 1.4; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 20px; position: relative;
            background: linear-gradient(to bottom, rgba(15, 16, 22, 0.2), rgba(15, 16, 22, 0.9)), 
                        url('https://static.vecteezy.com/system/resources/previews/007/046/592/original/abstract-technology-futuristic-concept-blue-glowing-neon-lines-on-dark-background-vector.jpg');
            background-size: cover; background-position: center;
            border-radius: 20px; box-shadow: 0 0 30px rgba(41, 121, 255, 0.2); border: 1px solid #2979ff;
        }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .podium-place { display: flex; flex-direction: column; align-items: center; margin: 0 5px; width: 30%; position: relative; animation: float 4s ease-in-out infinite; }
        .rank-1 { z-index: 10; padding-bottom: 15px; animation-delay: 0s; }
        .rank-2 { animation-delay: 1.5s; }
        .rank-3 { animation-delay: 0.8s; }
        
        .podium-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 10px; z-index: 2; }
        
        .podium-card-body { 
            background: rgba(20, 25, 40, 0.75); backdrop-filter: blur(8px); padding: 8px; border-radius: 15px; text-align: center; width: 100%; 
            border-top: 4px solid #333; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .p-name { font-weight: 800; font-size: 0.9rem; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-val { font-size: 1.1rem; font-weight: 800; margin: 3px 0; }
        .p-meta-dia { font-size: 0.65rem; color: #ccc; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; margin-top: 5px; }

        .rank-1 .podium-img { border-color: var(--gold); width: 110px; height: 110px; box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
        .rank-1 .podium-card-body { border-top-color: var(--gold); background: rgba(40, 30, 10, 0.8); }
        .rank-2 .podium-img { border-color: #c0c0c0; }
        .rank-2 .podium-card-body { border-top-color: #c0c0c0; }
        .rank-3 .podium-img { border-color: #cd7f32; }
        .rank-3 .podium-card-body { border-top-color: #cd7f32; }

        /* Lista */
        .list-section { flex: 1; background: rgba(21, 23, 32, 0.6); border-radius: 15px; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; border: 1px solid #2a2d3e; }
        .list-row { display: flex; align-items: center; background: var(--bg-card); padding: 6px 10px; border-radius: 8px; border: 1px solid #2a2d3e; transition: transform 0.2s; }
        
        .lr-rank { font-size: 0.9rem; font-weight: 800; color: #555; width: 20px; }
        .lr-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid #333; }
        .lr-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .lr-name { font-weight: 700; font-size: 0.8rem; }
        .lr-values { text-align: right; }
        .lr-total { font-weight: 800; color: var(--green); display: block; font-size: 1rem; }
        .lr-falta { font-size: 0.65rem; color: var(--red); }
        .meta-dia-badge { background: #333; color: var(--gold); padding: 1px 5px; border-radius: 4px; font-weight: 700; font-size: 0.65rem;}

        /* Overlays */
        #overlay-start, #overlay-evento { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        #overlay-start { background: rgba(0,0,0,0.8); }
        #overlay-evento { background: rgba(0,0,0,0.95); display: none; flex-direction: column; }
        #btn-start { padding: 15px 40px; font-size: 1.2rem; background: var(--green); color: #000; border: none; border-radius: 50px; font-weight: 900; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 20px rgba(0,230,118,0.4); }
        
        .evento-titulo { font-size: 3rem; font-weight: 900; margin-bottom: 20px; color: var(--green); text-transform: uppercase; }
        .evento-foto { width: 200px; height: 200px; border-radius: 50%; border: 8px solid #fff; object-fit: cover; margin-bottom: 20px; box-shadow: 0 0 50px rgba(255,255,255,0.2); }
        .evento-nome { font-size: 2.5rem; font-weight: 900; color: #fff; margin-bottom: 10px; }
        .evento-valor { font-size: 4rem; font-weight: 900; color: var(--gold); text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
    </style>
</head>
<body>

    <div id="overlay-start"><button id="btn-start">INICIAR SISTEMA</button></div>

    <div id="overlay-evento">
        <div class="evento-titulo">NOVA VENDA!</div>
        <img id="ev-foto" class="evento-foto" src="">
        <div id="ev-nome" class="evento-nome">NOME</div>
        <div id="ev-valor" class="evento-valor">R$ 0,00</div>
    </div>

    <audio id="som-caixa" src="https://www.myinstants.com/media/sounds/ka-ching.mp3"></audio> 
    <audio id="som-aplausos" src="https://www.myinstants.com/media/sounds/aplausos_2.mp3"></audio>

    <div class="main-header-title"><h1>GEST√ÉO √Ä VISTA <span>√ìTICAS AMMO</span></h1></div>

    <div class="header-metrics">
        <div class="metric-card">
            <h3>Meta Global</h3>
            <span class="value" id="meta-loja" style="color:var(--text-main)">...</span>
        </div>
        <div class="metric-card">
            <h3>Total M√™s</h3>
            <span class="value" id="realizado-loja" style="color:var(--green)">...</span>
        </div>
        <div class="metric-card">
            <h3>Vendido Hoje</h3>
            <span class="value" id="venda-hoje" style="color:var(--gold)">...</span>
        </div>
        <div class="metric-card">
            <h3>Dias Restantes</h3>
            <span class="value" id="dias-uteis" style="color:var(--blue)">...</span>
        </div>
    </div>

    <div class="chart-section">
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="podium-section" id="podium-container"></div>
        <div class="list-section" id="list-container"></div>
    </div>

<script>
    // ==========================================
    // ‚ö†Ô∏è SUA URL DO APPS SCRIPT AQUI:
    // ==========================================
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwrV_p243Yk3nknOxCdRflJSygi2a2Kl1HDGWlNBOXyzqE-PRsULLnGs7KKnoGVYrcz/exec"; 
    // ==========================================

    const equipe = [
        { nome: "ADRIANA VITORELLI", meta: 20000, foto: "https://i.postimg.cc/rwWD44QK/Whats-App-Image-2026-02-12-at-22-40-21.jpg" },
        { nome: "CLAUDIA LIZ", meta: 20000, foto: "https://i.postimg.cc/Nfx4Fdpd/Whats-App-Image-2026-02-13-at-11-01-21.jpg" },
        { nome: "PATRICIA", meta: 10000, foto: "https://i.postimg.cc/jd185pFj/Whats-App-Image-2026-02-13-at-11-02-53.jpg" },
        { nome: "GRACIELE", meta: 30000, foto: "https://i.postimg.cc/G3TnbnKP/Whats-App-Image-2026-02-13-at-11-07-00.jpg" },
        { nome: "LUAN", meta: 30000, foto: "https://i.postimg.cc/tCcrTKM9/Whats-App-Image-2026-02-13-at-11-02-45.jpg" },
        { nome: "RODRIGO", meta: 20000, foto: "https://i.postimg.cc/fTvKy88s/IMG-7897.avif" },
        { nome: "BEATRIZ", meta: 20000, foto: "https://i.postimg.cc/Qd84SV85/Whats-App-Image-2026-02-13-at-12-24-12.jpg" },
        { nome: "GEOVANNA", meta: 20000, foto: "https://i.postimg.cc/8cnQDWzF/Whats-App-Image-2026-02-13-at-14-01-47.jpg" },
        { nome: "CAROLINE", meta: 20000, foto: "https://i.postimg.cc/cC5yZYLv/Whats-App-Image-2026-02-13-at-13-58-55.jpg" },
        { nome: "DIENE", meta: 20000, foto: "https://i.postimg.cc/MKLsTCFq/Whats-App-Image-2026-02-13-at-11-02-41.jpg" },
        { nome: "BIANCA", meta: 20000, foto: "https://i.postimg.cc/SK9cysnH/Whats_App_Image_2026_02_13_at_11_16_23.jpg" },
        { nome: "VIVIANE", meta: 20000, foto: "https://i.postimg.cc/j5s2GdyV/Whats-App-Image-2026-02-13-at-11-19-43.jpg" },
        { nome: "GABRIELLY", meta: 25000, foto: "https://i.postimg.cc/MZfJzJ5R/Whats-App-Image-2026-02-13-at-11-12-49.jpg" },
        { nome: "RYANE", meta: 20000, foto: "https://i.postimg.cc/gJqRZTqN/Whats-App-Image-2026-02-13-at-11-17-57.jpg" },
        { nome: "SUELI", meta: 30000, foto: "https://i.postimg.cc/qRMn2Gbz/Whats-App-Image-2026-02-13-at-11-28-48.jpg" },
        { nome: "GISELI", meta: 20000, foto: "https://ui-avatars.com/api/?name=V16&background=random" },
        { nome: "CAMILA INGRA", meta: 30000, foto: "https://ui-avatars.com/api/?name=V17&background=random" },
        { nome: "Vendedor 18", meta: 0, foto: "https://ui-avatars.com/api/?name=V18&background=random" },
        { nome: "Vendedor 19", meta: 0, foto: "https://ui-avatars.com/api/?name=V19&background=random" },
        { nome: "Vendedor 20", meta: 0, foto: "https://ui-avatars.com/api/?name=V20&background=random" }
    ];

    let vendasAnteriores = {};
    let filaAnimacao = [];
    let isAnimando = false;
    let sistemaAtivo = false;
    let primeiraExecucao = true;
    let chartInstance = null;

    function formatMoney(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits:0}); }
    function normalizar(t) { return t ? t.toString().toUpperCase().trim() : ""; }
    function getAvatar(n) { return `https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=random&color=fff&size=128`; }

    function calcDiasRestantes() {
        let hoje = new Date();
        let ano = hoje.getFullYear();
        let mes = hoje.getMonth();
        let ultimoDia = new Date(ano, mes + 1, 0).getDate();
        let uteis = 0;
        for(let d = hoje.getDate(); d <= ultimoDia; d++) {
            let dataCheck = new Date(ano, mes, d);
            let diaSemana = dataCheck.getDay();
            if (diaSemana !== 0) uteis++;
        }
        return uteis > 0 ? uteis : 1;
    }

    function dispararEvento(nome, foto, valor) {
        filaAnimacao.push({nome, foto, valor});
        processarFila();
    }

    function processarFila() {
        if (isAnimando || filaAnimacao.length === 0) return;
        isAnimando = true;
        let ev = filaAnimacao.shift();
        let overlay = document.getElementById('overlay-evento');
        document.getElementById('ev-nome').innerText = ev.nome;
        document.getElementById('ev-valor').innerText = "+" + formatMoney(ev.valor);
        let img = document.getElementById('ev-foto');
        img.src = ev.foto;
        img.onerror = () => img.src = getAvatar(ev.nome);
        let audio = document.getElementById('som-aplausos');
        audio.currentTime = 0; audio.play().catch(e=>{});
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.style.display = 'none';
            isAnimando = false;
            processarFila();
        }, 5000);
    }

    // --- FUN√á√ÉO DE CRIA√á√ÉO DO GR√ÅFICO ---
    function updateChart(labels, dataTotal, dataHoje) {
        const ctx = document.getElementById('salesChart').getContext('2d');

        if (chartInstance) {
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = dataHoje; // Hoje primeiro (para visual)
            chartInstance.data.datasets[1].data = dataTotal;
            chartInstance.update();
        } else {
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Vendido HOJE',
                            data: dataHoje,
                            backgroundColor: '#ffd700', // Dourado
                            borderRadius: 4,
                            barPercentage: 0.7,
                            order: 1
                        },
                        {
                            label: 'Acumulado M√äS',
                            data: dataTotal,
                            backgroundColor: '#00e676', // Verde
                            borderRadius: 4,
                            barPercentage: 0.7,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff', font: {family: 'Montserrat'} } },
                        datalabels: { display: false } // Polui√ß√£o visual evitar
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#333' },
                            ticks: { color: '#888', font: {size: 10} }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#fff', font: {size: 9}, autoSkip: false, maxRotation: 90, minRotation: 90 }
                        }
                    },
                    animation: { duration: 1000 }
                }
            });
        }
    }

    function atualizar() {
        if (!sistemaAtivo) return;

        fetch(WEB_APP_URL + "?t=" + new Date().getTime())
        .then(res => res.json())
        .then(dados => {
            if (!dados || !dados.vendasHoje) return;

            let vendasMap = {};
            let hojeMap = {};
            let totalLoja = 0;
            let totalHojeLoja = 0;
            
            let d = new Date();
            let hojeStr = d.getFullYear() + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2);

            equipe.forEach(m => {
                let key = normalizar(m.nome);
                vendasMap[key] = 0;
                hojeMap[key] = 0;
            });

            dados.vendasHoje.forEach(v => {
                let nome = normalizar(v[0]);
                let valor = parseFloat(v[1]) || 0;
                let dataVenda = v[2];

                if (vendasMap[nome] !== undefined) {
                    vendasMap[nome] += valor;
                    totalLoja += valor;
                    if (dataVenda === hojeStr) {
                        hojeMap[nome] += valor;
                        totalHojeLoja += valor;
                    }
                }
            });

            if (!primeiraExecucao) {
                equipe.forEach(m => {
                    let key = normalizar(m.nome);
                    let novoTotal = vendasMap[key];
                    let antigoTotal = vendasAnteriores[key] || 0;
                    if (novoTotal > antigoTotal) {
                        let diff = novoTotal - antigoTotal;
                        dispararEvento(m.nome, m.foto, diff);
                        let cx = document.getElementById('som-caixa');
                        cx.currentTime=0; cx.play().catch(e=>{});
                    }
                });
            }
            
            equipe.forEach(m => vendasAnteriores[normalizar(m.nome)] = vendasMap[normalizar(m.nome)]);
            primeiraExecucao = false;

            let diasRestantes = calcDiasRestantes();
            let metaLojaTotal = equipe.reduce((acc, curr) => acc + curr.meta, 0);

            let ranking = equipe.map(m => {
                let key = normalizar(m.nome);
                let vendido = vendasMap[key];
                let hoje = hojeMap[key];
                let falta = m.meta - vendido;
                let metaDia = falta > 0 ? falta / diasRestantes : 0;

                return { ...m, vendido, hoje, falta, metaDia };
            });

            ranking.sort((a, b) => b.vendido - a.vendido);

            // ATUALIZA O GR√ÅFICO (Filtrar quem n√£o vendeu nada para limpar o visual?)
            // Optei por mostrar todos para verem quem est√° zerado tamb√©m
            const labels = ranking.map(r => r.nome.split(' ')[0]);
            const dataTotal = ranking.map(r => r.vendido);
            const dataHoje = ranking.map(r => r.hoje);
            updateChart(labels, dataTotal, dataHoje);

            renderizarTela(ranking, metaLojaTotal, totalLoja, totalHojeLoja, diasRestantes);

        }).catch(e => console.error("Erro conexao", e));
    }

    function renderizarTela(ranking, metaLoja, realizadoLoja, hojeLoja, diasUteis) {
        document.getElementById('meta-loja').innerText = formatMoney(metaLoja);
        document.getElementById('realizado-loja').innerText = formatMoney(realizadoLoja);
        document.getElementById('venda-hoje').innerText = formatMoney(hojeLoja);
        document.getElementById('dias-uteis').innerText = diasUteis;

        let podium = document.getElementById('podium-container');
        let list = document.getElementById('list-container');
        podium.innerHTML = "";
        list.innerHTML = "";

        if(ranking[1]) renderPodium(ranking[1], 2, podium);
        if(ranking[0]) renderPodium(ranking[0], 1, podium);
        if(ranking[2]) renderPodium(ranking[2], 3, podium);

        for(let i = 3; i < ranking.length; i++) {
            let r = ranking[i];
            if (r.meta === 0 && r.vendido === 0) continue;

            let htmlMetaDia = r.falta <= 0 ? `<span class="meta-dia-badge batido">BATIDA! üèÜ</span>` : `META HOJE: <span class="meta-dia-badge">${formatMoney(r.metaDia)}</span>`;
            
            // Adicionado indicador de venda HOJE na lista tamb√©m
            let htmlHojeLista = r.hoje > 0 ? `<span style="font-size:0.7rem; color:var(--gold); font-weight:bold; margin-right:5px;">(+${formatMoney(r.hoje)})</span>` : '';

            let div = document.createElement('div');
            div.className = "list-row";
            div.innerHTML = `
                <div class="lr-rank">${i+1}</div>
                <img src="${r.foto}" class="lr-avatar" onerror="this.src='${getAvatar(r.nome)}'">
                <div class="lr-info">
                    <div class="lr-name">${r.nome}</div>
                    <div class="meta-dia-box">${htmlMetaDia}</div>
                </div>
                <div class="lr-values">
                    <span class="lr-total">${htmlHojeLista} ${formatMoney(r.vendido)}</span>
                    <span class="lr-falta">Falta: ${formatMoney(Math.max(0, r.falta))}</span>
                </div>
            `;
            list.appendChild(div);
        }
    }

    function renderPodium(r, pos, container) {
        if (!r) return;
        let htmlMetaDia = r.falta <= 0 ? `<div style="color:var(--blue); font-weight:bold">BATIDA!</div>` : `<div>${formatMoney(r.metaDia)}</div>`;
        let htmlHoje = r.hoje > 0 ? `<div style="color:var(--gold); font-size:0.8rem; font-weight:bold; margin-top:2px;">HOJE: +${formatMoney(r.hoje)}</div>` : '';

        let div = document.createElement('div');
        div.className = `podium-place rank-${pos}`;
        div.innerHTML = `
            <img src="${r.foto}" class="podium-img" onerror="this.src='${getAvatar(r.nome)}'">
            <div class="podium-card-body">
                <div class="p-name">${r.nome.split(' ')[0]}</div>
                <div class="p-val">${formatMoney(r.vendido)}</div>
                ${htmlHoje}
                <div class="p-meta-dia">META HOJE ${htmlMetaDia}</div>
            </div>
        `;
        container.appendChild(div);
    }

    document.getElementById('btn-start').addEventListener('click', () => {
        document.getElementById('overlay-start').style.display = 'none';
        sistemaAtivo = true;
        ['som-caixa','som-aplausos'].forEach(id=>{ let a=document.getElementById(id); a.volume=0; a.play().then(()=>a.volume=1).catch(()=>{}); });
        atualizar();
        setInterval(atualizar, 5000);
    });

</script>
</body>
</html>
